#PBS -S /bin/bash
#PBS -A XMPTCA
#PBS -q tcaq 

#PBS -l select=4:mpiprocs=1
####PBS -l walltime=00:40:00
#PBS -l walltime=00:10:00

. /opt/Modules/default/init/bash
module purge
module load intel/15.0.2 intelmpi/5.0.0

cd $PBS_O_WORKDIR
###export XMP_ONESIDED_HEAP_SIZE=512M
###export XMP_ONESIDED_HEAP_SIZE=2048M
export XMP_ONESIDED_HEAP_SIZE=1024M
export GASNET_HOME=$HOME/local/GASNet-1.24.2-mvapich2-gdr

echo Environment -------
module list 2>&1
echo "pwd = "; pwd
echo "XMP_ONESIDED_HEAP_SIZE=$XMP_ONESIDED_HEAP_SIZE"
echo "GASNET_HOME=$GASNET_HOME"
echo -------------------


#EXE="mpi.x caf-direct.x caf-wide.x caf-narrow.x caf-fit.x mpi-nocom.x caf-nocom.x caf-direct-nocom.x"
###EXE="mpi.x mpi-nocom.x caf-wide.x caf-nocom.x caf-direct.x caf-direct-nocom.x caf-narrow.x caf-fit.x"
###EXE="caf-wide.x"
EXE="caf-fitp.x"

MODEL="M L XL"
SHAPE=122
SHAPES="1 2 2"
NODES=4

for m in ${MODEL}; do
INFILE=./stdin.${m}${SHAPE}
echo "$m" > ${INFILE}
echo "${SHAPES}" >> ${INFILE}

for f in ${EXE}; do
    echo
    echo "****************************************************"
    echo "himenoBMT $f $m ${SHAPE} ($m-model/${NODES} nodes)"
    echo "****************************************************"
    ### for IntelMPI
    if [[ $f =~ ^mpi ]]; then
        mpirun -np ${NODES} -s all ../$f < ${INFILE}
    else
        $GASNET_HOME/bin/gasnetrun_ibv -n ${NODES} -spawner=mpi ../$f < ${INFILE}
    fi
done

done

